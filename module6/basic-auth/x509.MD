### Create private key and csr

```sh
# 要为新用户申请证书，该新用户就必须要有自己的密钥
openssl genrsa -out myuser.key 2048
# 在有了密钥后，我们要向向证书注册的CA申请证书，还必须生成一张证书请求文件
# Kubernetes 使用证书中的 'subject' 的通用名称（Common Name）字段（例如，"/CN=bob"）来 确定用户名。
openssl req -new -key myuser.key -out myuser.csr
#openssl req -new -x509 -days 10000 -key .key -out <CA_public>.crt 
```

### Encode csr

```sh
cat myuser.csr | base64 | tr -d "\n"
```

### Replace request and create csr

```sh

# 1.22.2 版本写法
cat <<EOF | kubectl apply -f -
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: myuser
spec:
  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ3l6Q0NBYk1DQVFBd2dZVXhDekFKQmdOVkJBWVRBa05PTVJFd0R3WURWUVFJREFoVGFHRnVaMmhoYVRFUgpNQThHQTFVRUJ3d0lVMmhoYm1kb1lXa3hEekFOQmdOVkJBb01CbU51WTJGdGNERVBNQTBHQTFVRUN3d0dZMjVqCllXMXdNUTh3RFFZRFZRUUREQVpqYm1OaGJYQXhIVEFiQmdrcWhraUc5dzBCQ1FFV0RtTnVZMkZ0Y0VBeE5qTXUKWTI5dE1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBeG5LN09PRDEvR1FBR1ZZKwpBeVhhem85Y1FmKzFVTndNYk93M0pyaHV5R0ZvbnphU0FuSXhoZlFlVFRKSzJJUWlNODA5VU9ud2NpMnJ5RjRHCnVlaWRiMjlTZFc4VmJXZE9xWGRkWWhmTGJnZ0FtbFFNQmc5dTZPRWMrTW5OdStnM29ENGQvNTh0ZlBDbDQydnoKMURKbmFwa21ZWUs2UWpxanVQT2tqcUZQeElrMFphTFRWTlAvVk0zbGpGVnZWL2xNZlZ4RjdTMzEwSmhtRWNhcApMMHdXN0VNazdwV242aFJ3SkFsSkxQTHlSNGRiT1NhRFlpYWVqbHF5RWt4WFBWbE1EVmFieEF5Z01Ca2pJbGlxCjJ2dnJ3UERzYnorWXppMFRxVEpYamtzV3REUngxeXladU5DVkl4V01ib3IxdEI0c3NoOWk2dnhEakxFWGMwVjEKK204MmVRSURBUUFCb0FBd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFESWJ3S1JxVnQxWllmN3QzdVlsL3pybgpiV2JFbEFNUmY4UEhOTDl3SXRCRGpDMFZjb1pNdTFMVW9JNXN0V0V2Z0UwbFJLVTUwTkg4MG1XbmphbUViWGFMCkJWbXZNcGxFSEVVbk9tOXY1SGNIUzNZV3NEU1hocTVIOE5yb1dkNTNKN3NOazVkU25XYWJZa3RHMm9mWFIweVgKbEt4MGt5bW16ajJlTkFvMUFLTGIrUmVocW9od08xdlhnWEU4WXJvNUV6cFU0NFhGa0dHN2RyVWJ5MlZCMG5hQwpXZHZ1MVl0VGk1RVVhblNpK3BncC94aUtrb0s0MVlZMHIrOENSOUtHQk1vY2UvUGlRcDU0RThRMHNheU1KWXZuCmYxVTZmT3BiQUJ2aXIzWU9Vd3QwOHFZNlNnWmo3ZjZBRU5qcUU3T3pJVzg3QTZ2Z3B6WWNubXpOTFlWakp0OD0KLS0tLS1FTkQgQ0VSVElGSUNBVEUgUkVRVUVTVC0tLS0tCg==
  signerName: kubernetes.io/kube-apiserver-client
  expirationSeconds: 86400  # one day
  usages:
  - client auth
EOF

# 1.18.6 版本写法
cat <<EOF | kubectl apply -f -
apiVersion: certificates.k8s.io/v1beta1
kind: CertificateSigningRequest
metadata:
  name: myuser
spec:
  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQzNUQ0NBY1VDQVFBd2J6RUxNQWtHQTFVRUJoTUNRMDR4Q3pBSkJnTlZCQWdNQW1odU1Rc3dDUVlEVlFRSApEQUo2ZWpFTU1Bb0dBMVVFQ2d3RFpteDVNUXN3Q1FZRFZRUUxEQUptYXpFTU1Bb0dBMVVFQXd3RFpteDVNUjB3Ckd3WUpLb1pJaHZjTkFRa0JGZzVtYkhsQVoyMWhhV3hqTG1OdkxEQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQUQKZ2dFUEFEQ0NBUW9DZ2dFQkFMWVVaWC9KWW4yeFNTNzFCQ2F1NDhqN0F2RGFERGNqN201YUF3c21DREIvaFZ2MQpCVnZJSjhiS013NHA2VHpnYnRZWmJTSno1ZDdFTTFIQTM4NFplTTEycE51NWtmMVhFN3M0cm1PMktEWU9Nb2NnCkVpc0ZGRTlhbWdHb3l5R09oazRjWEswcGpIL0NlR0NBTjRENVFyVndzbi9RK29ULzZCV2J0eUkyYmNnSmhXVEgKNDFnenkweG5hNVFSSnBkU1NMWElGUkU0MmtBRWhuMVBvOXZ1bFhUczY1ZGVzdWs0WHZQU0RlWmxSMmtqRnhyMApYTldUblJjTFBBT3NtT3lWVFFVSzZ1YWlKd3gwUE5FNGtzY1R2eEM1V0dUR29TU2JwRU9CU1N2SXpNNmtZc1JUClJaM0pIR1pKNVBJcVUzR3dpeWxGSVF4U0k2NVQrQWNiNDZRZlpuMENBd0VBQWFBcE1CSUdDU3FHU0liM0RRRUoKQWpFRkRBTXhNVEV3RXdZSktvWklodmNOQVFrSE1RWU1CREV5TXpRd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQgpBQWhVNHZyQUVzazNCdmVxejJmdStnY2x4cFNwUUExaVlEbkFQa2VqUWJTN1VzanFKeG1iL1NONFpCNjdDSCtKCmZLdzM4dlFnb1BUd3RZOHVFajhJVmJRQmZ0U0dhcG5OUmZ1ZnkwS0VnVTVJWWtyeFYrKzRycmIxTGRLS0VQVTIKdlB3YUtZUllRYTZaemowcFZ4SjM2NjBQS1h0Uzhpc3MwWXhZY2tDZXlRbkZacmtYRTE2Nk16TVdzMGhDNkhmNAphUWhnVWUzSmJXSXgzQytZM2xpQzUveC8yc083V0pEalNiUGNmM3RIdHpzam1EcSs1OXhiSDB6VG9yRVNmN3puCndsVGRWZkU5Ry9kTk4xNmdRbE1iWUhxWjlaQ0ZicHUvMFBIZEVsOU9GVjg3dWdQWW9FZHpNYytab0pPWGoyUVUKZXN3Ykk5aUNERndTMWR5S0F5M29JenM9Ci0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=
  signerName: kubernetes.io/kube-apiserver-client
  usages:
  - client auth
EOF
```

### Approve csr

```sh
kubectl certificate approve myuser
```

### Check csr

```sh
kubectl get csr/myuser -o yaml
```

### Extract crt

```sh
kubectl get csr myuser -o jsonpath='{.status.certificate}'| base64 -d > myuser.crt
```

### Set credential

```sh
# 这里如果指定了一个已存在的username，将合并新字段并覆盖旧字段
kubectl config set-credentials myuser --client-key=myuser.key --client-certificate=myuser.crt --embed-certs=true

kubectl config set-credentials fly --client-key=myuser.key --client-certificate=myuser.crt --embed-certs=true

# 查看x509配置信息
cat ~/.kube/config
```

### Grant permission

```sh
# 1.22.2 版本写法
kubectl create role developer --verb=create --verb=get --verb=list --verb=update --verb=delete --2-pod-resource=pods

kubectl create rolebinding developer-binding-myuser --role=developer --user=myuser

# 1.18.6 版本写法
kubectl create role developer --verb=get,list,watch --resource=pods,pods/status

kubectl create rolebinding developer-binding-myuser --role=developer --user=myuser


kubectl create role developer --verb=get,list,watch --resource=pods,pods/status

kubectl create rolebinding developer-binding-flygit --role=developer --user=flygit
```

### Get pod

```bash
kubectl get pod  --user myuser
```

### Reset

```bash
# 删除 rolebinding
kubectl delete rolebinding developer-binding-myuser
# 删除 role
kubectl delete role developer
# 1.18.6 版本写法 删除 credentials, 编辑~/.kube/config 删除 - name: myuser 部分
vim ~/.kube/config
# - name: myuser
# 1.22.2 版本写法 删除 credentials
kubectl config delete-user myuser

# 删除 CertificateSigningRequest
kubectl delete CertificateSigningRequest myuser

rm -rf myuser.crt myuser.csr myuser.key

```

### 参考连接：

https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/